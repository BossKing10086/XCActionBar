//
//  XCActionBarSearchDataSource.m
//  XCActionBar
//
//  Created by Pedro Gomes on 09/04/2015.
//  Copyright (c) 2015 Pedro Gomes. All rights reserved.
//

#import "XCSearchService.h"
#import "XCActionBarSearchDataSource.h"

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
@interface XCActionBarSearchDataSource ()

@property (nonatomic, weak) id<XCSearchService> searchService;

@property (nonatomic, assign) NSInteger selectedObjectIndex;
@property (nonatomic,   copy) NSString  *searchQuery;
@property (nonatomic        ) NSArray   *searchResults;

@end

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
@implementation XCActionBarSearchDataSource

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
- (instancetype)initWithSearchService:(id<XCSearchService>)searchService
{
    if((self = [super init])) {
        self.selectedObjectIndex = -1;
        self.searchResults       = @[];
    }
    return self;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
- (void)updateSelectedObjectIndex:(NSUInteger)index
{
    self.selectedObjectIndex = index;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
- (void)updateSearchQuery:(NSString *)query
{
    XCDeclareWeakSelf(weakSelf);

    self.searchQuery = query;
    [self.searchService performSearchWithQuery:query
                             completionHandler:^(NSArray *results) {
                                 weakSelf.searchResults = results;
                             }];
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
- (NSUInteger)numberOfResults
{
    return self.searchResults.count;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
- (void)clearSearchResults
{
    self.searchQuery         = nil;
    self.searchResults       = @[];
    self.selectedObjectIndex = -1;
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
- (id<XCSearchMatchEntry>)objectAtIndex:(NSUInteger)index
{
    return self.searchResults[index];
}

////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////
- (id<XCSearchMatchEntry>)selectedObject
{
    return self.searchResults[self.selectedObjectIndex];
}

@end
